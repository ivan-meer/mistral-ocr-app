# Mistral OCR - PDF в Markdown/JSON Конвертер

![Mistral OCR App Screenshot](assets/img/banner.jpg)

Веб-приложение на базе Flask и Cloudflare Worker для извлечения текста и изображений из PDF-документов с использованием Mistral OCR API.

## Функциональные возможности

- **Современный интерфейс**: Минималистичный тёмный дизайн для Flask-приложения.
- **Два варианта развертывания**:
    - **Flask-приложение (Python)**: Полнофункциональное приложение с UI, API и обработкой файлов.
    - **Cloudflare Worker (JavaScript)**: Легковесная serverless-версия с базовым UI для OCR по URL или загрузке файла.
- **OCR для PDF**: Обработка PDF-документов, загруженных локально или по URL.
- **Два формата вывода (Flask)**: Markdown и JSON. Cloudflare Worker выводит только Markdown.
- **Встраивание изображений**: Преобразование изображений в base64 для включения в Markdown.
- **Демонстрационный режим (Flask)**: Работа без API-ключа Mistral с использованием демонстрационных данных.
- **Интегрированное API (Flask)**: REST API для интеграции с другими приложениями или кастомным GUI.
- **Обработка ссылок Google Drive**: Автоматическое преобразование ссылок Google Drive в прямые ссылки для скачивания.

## Структура проекта

```
mistral-ocr-app/
├── app.py                   # Основное Flask-приложение (Python)
├── index.js                 # Код для Cloudflare Worker (JavaScript)
├── requirements.txt         # Зависимости для Flask-приложения
├── .env.example             # Пример файла окружения для Flask
├── static/                  # Статические файлы для Flask (CSS, JS)
├── templates/               # HTML-шаблоны для Flask
├── main.py                  # Пример CLI-скрипта для прямого использования Mistral API
├── README.md                # Этот файл
└── ...                      # Другие файлы (изображения, .gitignore и т.д.)
```

## Требования

### Для Flask-приложения:
- Python 3.8 или выше
- API-ключ Mistral AI с доступом к OCR (опционально, можно использовать демо-режим)
- Зависимости из `requirements.txt`

### Для Cloudflare Worker:
- Аккаунт Cloudflare с доступом к Workers
- API-ключ Mistral AI (вводится пользователем в интерфейсе Worker)

## Установка и запуск

### 1. Flask-приложение (Python)

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/ivan-meer/mistral-ocr-app.git
    cd mistral-ocr-app
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    # для Windows
    python -m venv venv
    venv\Scripts\activate

    # для macOS/Linux
    python -m venv venv
    source venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта на основе `.env.example`:
    ```dotenv
    # Обязательно, если USE_MOCK_OCR=false
    MISTRAL_API_KEY=your_mistral_api_key_here

    # Использовать демо-режим OCR (true/false)
    USE_MOCK_OCR=true

    # Максимальный размер загружаемого файла в МБ
    MAX_FILE_SIZE_MB=50

    # Папка для временных файлов (по умолчанию системная временная папка)
    # UPLOAD_FOLDER=/path/to/your/upload/folder

    # Настройки сервера Flask
    HOST=0.0.0.0
    PORT=5000
    DEBUG=True
    ```
    Если у вас нет API-ключа Mistral, оставьте `USE_MOCK_OCR=true` для использования демо-режима.

5.  **Запустите приложение:**
    ```bash
    python app.py
    ```
    Приложение будет доступно по адресу `http://<HOST>:<PORT>` (например, `http://localhost:5000`).

### 2. Cloudflare Worker (JavaScript)

1.  Войдите в свою панель управления Cloudflare.
2.  Перейдите в раздел "Workers & Pages".
3.  Создайте новый Worker.
4.  Скопируйте содержимое файла `index.js` из этого репозитория и вставьте его в редактор кода Worker.
5.  Настройте триггеры (маршруты) для вашего Worker, если это необходимо.
6.  Сохраните и разверните Worker.
7.  Пользователи должны будут вводить свой API-ключ Mistral непосредственно в интерфейсе Worker.

## Использование Flask-приложения

### Пользовательский интерфейс:
1.  Откройте приложение в браузере (`http://localhost:5000` по умолчанию).
2.  Выберите способ загрузки документа: "Файл" (локальная загрузка) или "URL".
3.  Загрузите файл или введите URL-адрес PDF-документа.
    *   Поддерживаются прямые ссылки на PDF и ссылки Google Drive (автоматически конвертируются).
4.  Нажмите "Обработать документ".
5.  Результаты (текст Markdown и извлеченные изображения) будут отображены на странице.
6.  Используйте кнопки "Markdown" или "JSON" в заголовке результатов для скачивания соответствующего файла.

### Демо-режим vs Реальный OCR (Flask):
-   **Демо-режим (`USE_MOCK_OCR=true` в `.env`):**
    -   Не требует API-ключа Mistral.
    -   Возвращает демонстрационные данные, а не реальные результаты OCR.
    -   Подходит для тестирования интерфейса и базовой функциональности.
-   **Реальный OCR (`USE_MOCK_OCR=false` в `.env`):**
    -   Требует действительный `MISTRAL_API_KEY`.
    -   Обеспечивает реальное распознавание текста и изображений из PDF.

### API Endpoints (Flask)

Flask-приложение предоставляет следующие REST API эндпоинты, которые могут быть использованы для интеграции с кастомным GUI или другими сервисами. Все API эндпоинты поддерживают CORS.

#### 1. Загрузка и обработка документа
-   **URL:** `/upload`
-   **Метод:** `POST`
-   **Тип контента:** `multipart/form-data`
-   **Параметры формы:**
    -   `processing_type`: (обязательный) `file` или `url`.
    -   `document`:
        -   Если `processing_type=file`: сам файл документа.
        -   Если `processing_type=url`: строка с URL документа.
    -   `include_images`: (опциональный, boolean, по умолчанию `true`) `true` или `false`. Указывает, нужно ли извлекать и сохранять изображения.
-   **Успешный ответ (200 OK):**
    ```json
    {
      "status": "success",
      "data": {
        "document_url": "url_документа_от_mistral_api",
        "pages": [
          {
            "index": 0,
            "markdown": "markdown_текст_страницы_1",
            "images": [
              {
                "id": "image_id_1",
                "path": "локальный_путь_к_изображению_1_на_сервере",
                "url": "/image/page_0_img_image_id_1.png"
              }
            ]
          }
          // ... другие страницы
        ],
        "markdown_file": "имя_файла_результата.md",
        "json_file": "имя_файла_результата.json"
      }
    }
    ```
-   **Ответ с ошибкой:**
    ```json
    {
      "status": "error",
      "message": "Описание ошибки"
    }
    ```
    (HTTP статус 400, 500 или др. в зависимости от ошибки)

#### 2. Получение OCR результата в формате Markdown по URL
-   **URL:** `/api/markdown`
-   **Метод:** `GET`
-   **Query параметры:**
    -   `url`: (обязательный) URL-адрес PDF-документа.
    -   `include_images`: (опциональный, boolean, по умолчанию `true`) `true` или `false`. Если `true`, изображения будут встроены в Markdown как base64.
-   **Успешный ответ (200 OK):**
    ```json
    {
      "status": "success",
      "markdown": "Полный_markdown_текст_документа_с_встроенными_base64_изображениями",
      "source_document_url": "url_документа_от_mistral_api"
    }
    ```

#### 3. Получение OCR результата в формате JSON по URL
-   **URL:** `/api/json`
-   **Метод:** `GET`
-   **Query параметры:**
    -   `url`: (обязательный) URL-адрес PDF-документа.
    -   `include_images`: (опциональный, boolean, по умолчанию `true`) `true` или `false`.
-   **Успешный ответ (200 OK):**
    ```json
    {
      "status": "success",
      "data": {
        "source_document_url": "url_документа_от_mistral_api",
        "pages": [
          {
            "index": 0,
            "markdown": "markdown_текст_страницы_1",
            "images": [ // Поле присутствует, если include_images=true и изображения найдены
              {
                "id": "image_id_1",
                "url": "/image/page_0_img_image_id_1.png" // URL для загрузки изображения через API
              }
            ]
          }
          // ... другие страницы
        ]
      }
    }
    ```

#### 4. Проверка статуса API
-   **URL:** `/api/status`
-   **Метод:** `GET`
-   **Успешный ответ (200 OK):**
    -   Если используется моковый режим: `{"status": "success", "message": "Работа в демонстрационном режиме."}`
    -   Если API Mistral доступно: `{"status": "success", "message": "API Mistral доступно (базовая проверка)."}`
-   **Ответ с ошибкой (503 Service Unavailable):**
    -   Если API-ключ не настроен: `{"status": "error", "message": "API-ключ Mistral не настроен."}`
    -   Если ошибка подключения к API: `{"status": "error", "message": "Ошибка подключения к Mistral API: ..."}`

#### 5. Скачивание файлов результатов
-   **URL для Markdown:** `/download/markdown/<filename>`
-   **URL для JSON:** `/download/json/<filename>`
-   **Метод:** `GET`
-   `<filename>` - это имя файла, полученное из ответа эндпоинта `/upload` (поля `markdown_file` или `json_file`).
-   Эти эндпоинты инициируют скачивание файла браузером.

#### 6. Получение изображения
-   **URL:** `/image/<filename>`
-   **Метод:** `GET`
-   `<filename>` - это имя файла изображения (например, `page_0_img_image_id_1.png`), полученное из ответа `/upload` (поле `url` внутри массива `images`) или `/api/json`.
-   Этот эндпоинт возвращает файл изображения.

## Cloudflare Worker (`index.js`)

Cloudflare Worker предоставляет упрощенный интерфейс для OCR через Mistral API.
-   **Развертывание:** Скопируйте код из `index.js` в новый Cloudflare Worker.
-   **Использование:** Откройте URL вашего Worker в браузере. Введите API-ключ Mistral и URL PDF-документа или загрузите файл. Результат будет предоставлен в виде скачиваемого Markdown-файла.
-   **Ограничения:** Worker возвращает только Markdown, изображения встраиваются как base64. Нет расширенного JSON-вывода или предпросмотра изображений как в Flask-приложении. API-ключ хранится в `localStorage` браузера.

## Ограничения

-   **Демо-режим (Flask):** Возвращает фиксированные данные, а не реальные результаты OCR.
-   **Mistral API:** При использовании реального OCR возможны ограничения со стороны Mistral API (размер файлов, количество запросов, доступность по регионам).
-   **Формат DOCX:** Напрямую не обрабатывается Mistral OCR. Для обработки DOCX файлов их необходимо предварительно конвертировать в PDF или извлекать текст другим способом. Текущая реализация позволяет загружать DOCX, но OCR может не сработать корректно.

## Дальнейшее развитие

-   Добавление поддержки большего числа форматов входных документов (например, автоматическая конвертация DOCX в PDF перед OCR).
-   Реализация асинхронной обработки для больших файлов.
-   Улучшение пользовательского интерфейса, добавление кастомизации вывода.
-   Внедрение системы аутентификации для Flask API.
-   Написание автоматизированных тестов.

## Лицензия

MIT

## Авторы

Ivan Meer
